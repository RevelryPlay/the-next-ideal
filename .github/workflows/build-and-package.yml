name: Build and Package

on:
  push:
    branches:
      - main
    tags:
      - 'v*.*.*'  # Triggers on version tags like v1.0.0, v2.1.3, etc.

jobs:
  build-and-package:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build application
        run: npm run build

      - name: Prepare deployment package
        run: |
          mkdir -p deploy-package

          # Copy built assets (includes index.html and public assets)
          cp -r dist deploy-package/

          # Copy server file
          cp server.js deploy-package/

          # Copy package files (needed for npm install in production)
          cp package.json deploy-package/
          cp package-lock.json deploy-package/

      - name: Create zip archive
        run: |
          cd deploy-package
          zip -r ../landing-page-deploy.zip .
          cd ..

      - name: Upload deployment artifact
        uses: actions/upload-artifact@v4
        with:
          name: landing-page-deployment
          path: landing-page-deploy.zip
          retention-days: 30

      - name: Create GitHub Release
        if: startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v2
        with:
          files: landing-page-deploy.zip
          generate_release_notes: true
          body: |
            ## Deployment Package

            Download `landing-page-deploy.zip` and extract it on your server.

            ### Installation Steps
            1. Extract the package to your server
            2. Run: `npm ci --omit=dev`
            3. Start the server: `npm start`

            ### Package Contents
            - Built assets (dist/)
            - Server file (server.js)
            - Entry point (index.html)
            - Public assets (public/)
            - Dependencies manifest (package.json, package-lock.json)
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Upload summary
        run: |
          if [[ "${{ github.ref }}" == refs/tags/* ]]; then
            echo "### GitHub Release Created :rocket:" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Release Information:**" >> $GITHUB_STEP_SUMMARY
            echo "- Tag: ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
            echo "- Commit: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "View the release at: ${{ github.server_url }}/${{ github.repository }}/releases/tag/${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          else
            echo "### Deployment Package Created :rocket:" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Build Information:**" >> $GITHUB_STEP_SUMMARY
            echo "- Commit: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
            echo "- Branch: ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
            echo "- Artifact: landing-page-deployment" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Package Contents:**" >> $GITHUB_STEP_SUMMARY
          echo "- Built assets (dist/)" >> $GITHUB_STEP_SUMMARY
          echo "- Server file (server.js)" >> $GITHUB_STEP_SUMMARY
          echo "- Entry point (index.html)" >> $GITHUB_STEP_SUMMARY
          echo "- Public assets (public/)" >> $GITHUB_STEP_SUMMARY
          echo "- Dependencies manifest (package.json, package-lock.json)" >> $GITHUB_STEP_SUMMARY

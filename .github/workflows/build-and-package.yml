name: Build and Package

on:
  push:
    branches:
      - main

jobs:
  build-and-package:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build application
        run: npm run build

      - name: Prepare deployment package
        run: |
          mkdir -p deploy-package

          # Copy built assets
          cp -r dist deploy-package/

          # Copy server files
          cp server.js deploy-package/
          cp server.config.js deploy-package/ || cp server.config.example.js deploy-package/server.config.js

          # Copy public assets
          cp -r public deploy-package/

          # Copy package files (needed for npm install in production)
          cp package.json deploy-package/
          cp package-lock.json deploy-package/

          # Copy PM2 ecosystem config if using PM2
          cp ecosystem.config.cjs deploy-package/

          # Copy any additional config files
          cp .nvmrc deploy-package/ || true

          # Create a simple deployment README
          echo "# Deployment Package" > deploy-package/DEPLOY.md
          echo "" >> deploy-package/DEPLOY.md
          echo "## Installation" >> deploy-package/DEPLOY.md
          echo "1. Extract this package to your server" >> deploy-package/DEPLOY.md
          echo "2. Run: npm ci --omit=dev" >> deploy-package/DEPLOY.md
          echo "3. Configure server.config.js with your settings" >> deploy-package/DEPLOY.md
          echo "4. Start the server: npm start" >> deploy-package/DEPLOY.md
          echo "" >> deploy-package/DEPLOY.md
          echo "## PM2 Deployment (Optional)" >> deploy-package/DEPLOY.md
          echo "If using PM2: pm2 start ecosystem.config.cjs" >> deploy-package/DEPLOY.md

      - name: Create zip archive
        run: |
          cd deploy-package
          zip -r ../landing-page-deploy.zip .
          cd ..

      - name: Upload deployment artifact
        uses: actions/upload-artifact@v4
        with:
          name: landing-page-deployment
          path: landing-page-deploy.zip
          retention-days: 30

      - name: Upload artifact summary
        run: |
          echo "### Deployment Package Created :rocket:" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Build Information:**" >> $GITHUB_STEP_SUMMARY
          echo "- Commit: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "- Branch: ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "- Artifact: landing-page-deployment" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Package Contents:**" >> $GITHUB_STEP_SUMMARY
          echo "- Built assets (dist/)" >> $GITHUB_STEP_SUMMARY
          echo "- Server files (server.js, server.config.js)" >> $GITHUB_STEP_SUMMARY
          echo "- Public assets (public/)" >> $GITHUB_STEP_SUMMARY
          echo "- Dependencies manifest (package.json, package-lock.json)" >> $GITHUB_STEP_SUMMARY
          echo "- PM2 configuration (ecosystem.config.cjs)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Download the artifact from the Actions tab to deploy." >> $GITHUB_STEP_SUMMARY
